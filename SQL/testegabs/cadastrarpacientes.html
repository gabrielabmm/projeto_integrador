<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Paciente - SIDCC</title>
    <link rel="stylesheet" href="cadastrarpacientes.css" />
    <style>
        .mensagem-erro-campo {
            color: #D8000C;
            padding: 5px 8px;
            margin-top: 4px;
            border-radius: 4px;
            font-size: 0.85em;
            display: none;
        }

        /* Estilos adicionais para a imagem de perfil */
        .profile-image-wrapper {
            position: relative;
            width: 100px; /* Igual ao .avatar */
            height: 100px; /* Igual ao .avatar */
            border-radius: 50%;
            overflow: hidden;
            background-color: #eee; /* Cor de fundo para o caso de não haver imagem */
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px; /* Mantém o espaçamento original do .avatar */
        }

        .profile-image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Garante que a imagem cubra o círculo */
            border-radius: 50%; /* Para garantir que a imagem interna também seja redonda */
        }

        .upload-button-label { /* Estilo para o label que age como botão de upload */
            background-color: #2e8b57;
            color: white;
            border: none;
            padding: 5px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            display: inline-block; /* Para que padding e margin funcionem corretamente */
            margin-top: 10px; /* Espaçamento entre o nome e o botão de upload */
        }

        .upload-button-label:hover {
            background-color: #267448;
        }
    </style>
</head>
<body id="paginaCadastroPaciente">
    <header class="topo">
        <div class="logo">
            <img src="logo.png" alt="Logo SIDCC">
            <span class="logo-text-sidcc"> <span class="char-s">S</span><span class="char-i">I</span><span class="char-d">D</span><span class="char-c1">C</span><span class="char-c2">C</span></span>
        </div>
        <div class="grupo-menu">
            <nav class="menu">
                <a href="iniciomedico.html">Início</a> <a href="#">Sobre</a> <a href="#">SAC</a>
            </nav>
            <img src="ruiva.png" alt="Perfil" class="icone-perfil" />
        </div>
    </header>

    <main class="conteudo">
        <h2>Olá, <span id="nomeMedicoLogado">&lt;NOME&gt;</span>!</h2>
        <section class="cartao">
            <div class="perfil">
                <div class="profile-image-wrapper">
                    <img id="profileImage" src="/get-profile-image-blob?id=1" alt="Imagem de Perfil" class="profile-image">
                </div>
                <p class="nome">Nome Paciente</p>
                <input type="file" id="imageUpload" accept="image/*" name="profile_image" style="display: none;">
                <label for="imageUpload" class="upload-button-label">Adicionar foto</label>
                <input type="hidden" id="pacienteIdParaImagem" name="paciente_id" value="1">
            </div>

            <div class="info-formulario">
                <form id="formCadastroPaciente">
                    <h3>Dados pessoais</h3>
                    <div class="grade-formulario">
                        <label>Nome*: <input name="pacienteNome" required id="pacienteNome" /></label>
                        <label>Nome social: <input type="text" id="pacienteNomeSocial" name="pacienteNomeSocial" /></label>
                        <label>Nome da mãe: <input type="text" id="pacienteNomeMae" name="pacienteNomeMae" /></label>
                        <label>Cartão SUS*: <input name="pacienteCartaoSUS" required id="pacienteCartaoSUS" maxlength="19" /></label>
                        <label>Data de Nascimento*:<input name="pacienteDataNascimento" type="date" required id="pacienteDataNascimento" /></label>
                        <label>Nacionalidade*:<input name="pacienteNacionalidade" id="pacienteNacionalidade" value="Brasileira" /></label>
                        <label>Raça:
                            <select id="pacienteRacaSelect" name="pacienteRacaSelect">
                                <option value="">Selecione...</option>
                                <option value="Branca">Branca</option>
                                <option value="Preta">Preta</option>
                                <option value="Parda">Parda</option>
                                <option value="Indigena">Indígena</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </label>
                        <div id="containerRacaOutros" style="display:none;">
                            <label>Qual Raça?:<input type="text" id="pacienteRacaOutros" name="pacienteRacaOutros" /></label>
                        </div>
                        <label>Escolaridade:
                            <select id="pacienteEscolaridadeSelect" name="pacienteEscolaridadeSelect">
                                <option value="">Selecione...</option>
                                <option value="Analfabeta">Analfabeta</option>
                                <option value="Ensino Fundamental Incompleto">Ensino Fundamental Incompleto</option>
                                <option value="Ensino Fundamental Completo">Ensino Fundamental Completo</option>
                                <option value="Ensino Médio Completo">Ensino Médio Completo</option>
                                <option value="Ensino Superior Completo">Ensino Superior Completo</option>
                            </select>
                        </label>
                        <label>CPF*:
                            <input type="text" id="pacienteCPF" name="pacienteCPF" placeholder="000.000.000-00" maxlength="14" />
                        </label>
                        <label>Celular (com DDD)*:<input type="text" id="pacienteCelular" name="pacienteCelular" maxlength="15" /></label>
                        <label>Telefone Fixo (com DDD):<input type="text" id="pacienteTelefone" name="pacienteTelefone" maxlength="14" /></label>
                        <label>Email: <input type="email" id="pacienteEmail" name="pacienteEmail" /></label>
                    </div>

                    <h3>Dados residenciais</h3>
                    <div class="grade-formulario">
                        <label>CEP*: <input type="text" id="pacienteCEP" name="pacienteCEP" maxlength="9" /></label>
                        <label>Cidade*: <input type="text" id="pacienteCidade" name="pacienteCidade" /></label>
                        <label>Estado (UF)*:
                            <select id="pacienteEstadoSelect" name="pacienteEstadoSelect">
                                <option value="">Selecione UF...</option>
                                <option value="AC">AC</option><option value="AL">AL</option><option value="AP">AP</option>
                                <option value="AM">AM</option><option value="BA">BA</option><option value="CE">CE</option>
                                <option value="DF">DF</option><option value="ES">ES</option><option value="GO">GO</option>
                                <option value="MA">MA</option><option value="MT">MT</option><option value="MS">MS</option>
                                <option value="MG">MG</option><option value="PA">PA</option><option value="PB">PB</option>
                                <option value="PR">PR</option><option value="PE">PE</option><option value="PI">PI</option>
                                <option value="RJ">RJ</option><option value="RN">RN</option><option value="RS">RS</option>
                                <option value="RO">RO</option><option value="RR">RR</option><option value="SC">SC</option>
                                <option value="SP">SP</option><option value="SE">SE</option><option value="TO">TO</option>
                            </select>
                        </label>
                        <label>Logradouro: <input type="text" id="pacienteLogradouro" name="pacienteLogradouro" /></label>
                        <label>Nº residência: <input type="text" id="pacienteNumeroResidencia" name="pacienteNumeroResidencia" /></label>
                        <label>Setor: <input type="text" id="pacienteSetor" name="pacienteSetor" /></label>
                        <label>Complemento: <input type="text" id="pacienteComplemento" name="pacienteComplemento" /></label>
                        <label>Ponto de referência: <input type="text" id="pacientePontoReferencia" name="pacientePontoReferencia" /></label>
                    </div>

                    <div class="botao-cadastro">
                        <button type="submit" id="btnCadastrarPaciente" class="botao">Cadastrar paciente</button>
                    </div>
                </form>
            </div>
        </section>
    </main>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("formCadastroPaciente");
            const imageUploadInput = document.getElementById('imageUpload');
            const profileImageElement = document.getElementById('profileImage');
            const pacienteIdParaImagemInput = document.getElementById('pacienteIdParaImagem');

            // Set a default patient ID for image operations.
            // !!! IMPORTANT: In a real application, this ID should come from a secure source
            // (e.g., after the patient is successfully created/retrieved, or from a user session/JWT).
            // For this example, we'll use a placeholder ID like '1'.
            // If you're creating a *new* patient, you'd need to get the ID back from the
            // `inserirPacienteAPI` response and then use that ID for image uploads.
            // For now, let's assume we're dealing with patient ID 1 for testing purposes.
            const currentPacienteId = 1; // Placeholder ID
            pacienteIdParaImagemInput.value = currentPacienteId; // Set the hidden input value
            profileImageElement.src = `/get-profile-image-blob?id=${currentPacienteId}`; // Load current image


            // Handle image upload change
            imageUploadInput.addEventListener('change', async function() {
                const file = this.files[0];
                if (file) {
                    // Pré-visualiza a imagem
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        profileImageElement.src = e.target.result;
                    };
                    reader.readAsDataURL(file);

                    // Cria um FormData para enviar a imagem
                    const formData = new FormData();
                    formData.append('profile_image', file);
                    formData.append('paciente_id', pacienteIdParaImagemInput.value); // Envia o ID do paciente

                    try {
                        const response = await fetch("http://localhost:8080/upload-profile-image", {
                            method: "POST",
                            body: formData, // FormData não precisa de Content-Type manual
                        });

                        if (response.ok) {
                            const text = await response.text();
                            alert("Imagem de perfil atualizada com sucesso: " + text);
                            // Recarregar a imagem do servidor para garantir que o BLOB salvo seja exibido
                            profileImageElement.src = `/get-profile-image-blob?id=${currentPacienteId}&_t=${new Date().getTime()}`;
                        } else {
                            const text = await response.text();
                            alert("Erro ao enviar imagem: " + text);
                            // Se der erro, talvez resetar a pré-visualização ou carregar o avatar padrão
                            profileImageElement.src = `/get-profile-image-blob?id=${currentPacienteId}`;
                        }
                    } catch (error) {
                        alert("Erro ao conectar com o servidor de imagem: " + error.message);
                        profileImageElement.src = `/get-profile-image-blob?id=${currentPacienteId}`;
                    }
                }
            });


            form.addEventListener("submit", async function (event) {
                event.preventDefault();

                const limparMascara = (valor) => valor.replace(/\D/g, '');

                const celularCompleto = limparMascara(form.pacienteCelular.value);

                let ddd = "";
                let telefone = "";
                if (celularCompleto.length >= 10) {
                    ddd = celularCompleto.substring(0, 2);
                    telefone = celularCompleto.substring(2);
                } else {
                    telefone = celularCompleto;
                }

                const data = {
                    cartao_sus: form.pacienteCartaoSUS.value,
                    cpf: form.pacienteCPF.value,
                    nome: form.pacienteNome.value,
                    data_nasc: form.pacienteDataNascimento.value,
                    cep: form.pacienteCEP.value,
                    ddd: ddd,
                    telefone: telefone,
                    nacionalidade: form.pacienteNacionalidade.value,
                    uf: form.pacienteEstadoSelect.value,
                    nome_mae: form.pacienteNomeMae.value,
                    raca_cor: form.pacienteRacaSelect.value,
                    escolaridade: form.pacienteEscolaridadeSelect.value,
                    nome_social: form.pacienteNomeSocial.value,
                    logradouro: form.pacienteLogradouro.value,
                    setor: form.pacienteSetor.value,
                    cod_municipio: "",
                    complemento: form.pacienteComplemento.value,
                    ponto_referencia: form.pacientePontoReferencia.value,
                    numero_residencia: form.pacienteNumeroResidencia.value,
                    // ImagemPerfilURL não é enviada no cadastro inicial se for BLOB.
                    // A imagem é tratada em um endpoint separado.
                };

                try {
                    const response = await fetch("http://localhost:8080/pacientes", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data),
                    });

                    if (response.ok) {
                        alert("Paciente cadastrado com sucesso!");
                        form.reset();
                        // Se você quiser que o ID do paciente recém-criado seja usado para a imagem,
                        // o backend precisaria retornar o ID aqui.
                        // Ex: const newPatient = await response.json();
                        // pacienteIdParaImagemInput.value = newPatient.id;
                    } else {
                        const text = await response.text();
                        alert("Erro ao cadastrar paciente: " + text);
                    }
                } catch (error) {
                    alert("Erro ao conectar com o servidor: " + error.message);
                }
            });
        });
    </script>
    <script src="geral.js" defer></script>
</body>
</html>
